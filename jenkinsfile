pipeline {
    agent {
        docker {
            image 'maven:3.8.6-openjdk-11'
            args '-u root:root'
        }
    }
    stages {
        stage('Run  Tests') {
            steps {
                sh 'mvn clean install -DskipTests'
                sh 'mvn jmeter:configure'
                sh 'mvn compile'
                // sh 'mvn jmeter:jmeter'

            }
        }
         stage('Run JMeter ') {
            steps {
                sh 'mvn jmeter:jmeter'
                
            }
        }
    }
 post {
    always {
        def jobName = env.JOB_NAME
        def buildNumber = env.BUILD_NUMBER
        def buildUrl = env.BUILD_URL
        def result = currentBuild.currentResult
        def duration = currentBuild.durationString
        def startedAt = new Date(currentBuild.startTimeInMillis)
        def triggeredBy = currentBuild.getBuildCauses()[0]?.userName ?: "Automatique ou inconnu"

        mail(
            to: 'ahmedzwawi46@gmail.com',
            subject: "Pipeline ${jobName} - Build #${buildNumber} - ${result}",
            body: """\
Bonjour Ahmed 👋

Le pipeline **${jobName}** a terminé avec le statut : **${result}**

🔧 Détails du build :
- 🆔 Build numéro : ${buildNumber}
- 🕒 Démarré à : ${startedAt}
- ⏱️ Durée : ${duration}
- 👤 Déclenché par : ${triggeredBy}
- 🔗 Lien Jenkins : ${buildUrl}

Cordialement,  
Ton Jenkins préféré 🤖
"""
        )
    }
}



}
