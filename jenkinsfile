pipeline {
    agent {
        docker {
            image 'maven:3.8.6-openjdk-11'
            args '-u root:root'
        }
    }
    stages {
        stage('Run Tests') {
            steps {
                // ExÃ©cution des tests avec JaCoCo pour gÃ©nÃ©rer le rapport de couverture de code
                sh 'mvn clean install -DskipTests'  // Compile sans tests
                sh 'mvn test'  // Lance les tests et gÃ©nÃ¨re les rapports JaCoCo
            }
        }
        stage('Run JMeter') {
            steps {
                sh 'mvn jmeter:jmeter'
            }
        }
        stage('Generate JaCoCo Report') {
            steps {
                // GÃ©nÃ©re le rapport JaCoCo
                sh 'mvn jacoco:report'
            }
        }
    }
    post {
        always {
            // Envoie un e-mail avec les dÃ©tails du build
            mail(
                to: 'ahmedzwawi46@gmail.com',
                subject: "[Jenkins] ğŸ“¦ ${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${currentBuild.currentResult}",
                body: """\
Bonjour,

Le pipeline : ${env.JOB_NAME} (Build #${env.BUILD_NUMBER}) s'est exÃ©cutÃ© avec le statut : ${currentBuild.currentResult}.

ğŸ‘¤ ${currentBuild.getBuildCauses()[0]?.shortDescription ?: 'Non spÃ©cifiÃ©'}
ğŸ“… Date       : ${new Date().format("dd/MM/yyyy HH:mm", TimeZone.getTimeZone('Europe/Paris'))}
â±ï¸ DurÃ©e     : ${currentBuild.durationString}
ğŸ”€ Branche    : ${env.GIT_BRANCH ?: 'Branche non dÃ©finie'}
ğŸ”— Lien vers le build : ${env.BUILD_URL}
ğŸ“„ Console output : ${env.BUILD_URL}console

Cordialement,  
Votre Jenkins prÃ©fÃ©rÃ©
"""
            )
        }
        success {
            // Ajouter l'URL du rapport JaCoCo dans l'email en cas de succÃ¨s
            mail(
                to: 'ahmedzwawi46@gmail.com',
                subject: "[Jenkins] ğŸ“¦ ${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${currentBuild.currentResult}",
                body: """\
Bonjour,

Le pipeline : ${env.JOB_NAME} (Build #${env.BUILD_NUMBER}) s'est exÃ©cutÃ© avec succÃ¨s.

ğŸ‘‰ Rapport JaCoCo : ${env.BUILD_URL}artifact/target/site/jacoco/index.html

Cordialement,  
Votre Jenkins prÃ©fÃ©rÃ©
"""
            )
        }
    }
}
