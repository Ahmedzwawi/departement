pipeline {
    agent {
        docker {
            image 'maven:3.8.6-openjdk-11'
            args '-u root:root'
        }
    }
    stages {
        stage('Run  Tests') {
            steps {
                sh 'mvn clean install -DskipTests'
                sh 'mvn jmeter:configure'
                sh 'mvn compile'
                // sh 'mvn jmeter:jmeter'

            }
        }
         stage('Run JMeter ') {
            steps {
                sh 'mvn jmeter:jmeter'
                
            }
        }
    }
 post {
    always {
        def jobName = env.JOB_NAME
        def buildNumber = env.BUILD_NUMBER
        def buildUrl = env.BUILD_URL
        def result = currentBuild.currentResult
        def duration = currentBuild.durationString
        def startedAt = new Date(currentBuild.startTimeInMillis)
        def triggeredBy = currentBuild.getBuildCauses()[0]?.userName ?: "Automatique ou inconnu"

        mail(
            to: 'ahmedzwawi46@gmail.com',
            subject: "Pipeline ${jobName} - Build #${buildNumber} - ${result}",
            body: """\
Bonjour Ahmed ğŸ‘‹

Le pipeline **${jobName}** a terminÃ© avec le statut : **${result}**

ğŸ”§ DÃ©tails du build :
- ğŸ†” Build numÃ©ro : ${buildNumber}
- ğŸ•’ DÃ©marrÃ© Ã  : ${startedAt}
- â±ï¸ DurÃ©e : ${duration}
- ğŸ‘¤ DÃ©clenchÃ© par : ${triggeredBy}
- ğŸ”— Lien Jenkins : ${buildUrl}

Cordialement,  
Ton Jenkins prÃ©fÃ©rÃ© ğŸ¤–
"""
        )
    }
}



}
